
#
# Mac
#
brew update
brew install pyenv
brew install pyenv-virtualenv
xcode-select --install
#
# Other
#
git clone https://github.com/pyenv/pyenv.git ~/.pyenv
git clone https://github.com/pyenv/pyenv-virtualenv.git \
    ~/.pyenv/plugins-virtualenv

source ~/.bash_profile  # see dotfiles repo

# after installing python2 and 3; or, substitute other versions
CFLAGS="-O2" pyenv install $(python2 --version 2>&1 | sed 's/^.* //')
CFLAGS="-O2" pyenv install $(python3 --version 2>&1 | sed 's/^.* //')

# this doesn't work properly on Mac; use venvs and manual symlinks instead
#pyenv deactivate
#pip3 install virtualenv
#curl https://raw.githubusercontent.com/mitsuhiko/pipsi/master/get-pipsi.py | python3

# consider removing these from the main system:
#autopep8
#flake8

py3ver="3.6.5"  # or whatever
py2ver="2.7.14"  # or whatever
#
# see dot.bashrc.d/python.post for pyinst
pyinst coverage "$py3ver"
pyinst flake8 "$py3ver"
pyinst nose "$py3ver"
pyinst pytest "$py3ver"
pyinst sphinx "$py2ver"
pyinst tox "$py3ver"
#
pyenv activate "flake8-$py3ver"
pip3 install autopep8 flake8-import-order
pyenv activate "pytest-$py3ver"
pip3 install pytest-asyncio pytest-catchlog pytest-cov pytest-mock
pyenv activate "sphinx-$py2ver"
pip2 install recommonmark repoze.sphinx.autointerface sphinx-autobuild
pip2 install sphinxcontrib-zopeext zope.interface
pyenv deactivate
#
cd ~/bin
ln -s "../.pyenv/versions/coverage-${py3ver}/bin/coverage-3.6" .
ln -s "../.pyenv/versions/coverage-${py3ver}/bin/coverage3" .
ln -s "../.pyenv/versions/flake8-${py3ver}/bin/autopep8" .
ln -s "../.pyenv/versions/flake8-${py3ver}/bin/pycodestyle" .
ln -s "../.pyenv/versions/flake8-${py3ver}/bin/pyflakes" .
ln -s "../.pyenv/versions/nose-${py3ver}/bin/nosetests" .
ln -s "../.pyenv/versions/nose-${py3ver}/bin/nosetests-3.4" .
ln -s "../.pyenv/versions/pytest-${py3ver}/bin/py.test" .
# more from sphinx?
ln -s "../.pyenv/versions/sphinx-${py2ver}/bin/sphinx-{apidoc,autobuild,autogen,build,quickstart} .
ln -s "../.pyenv/versions/tox-${py3ver}/bin/tox-quickstart" .
rm nose sphinx
cd

cat >> ~/.flake8 <<EOF
[flake8]
import-order-style = edited
EOF

# I haven't figured out how to make new virtualenvs have new pip;
# pyenv global 3.6.5; pyenv deactivate; pip install --upgrade pip
# will update the base image, but that apparently won't affect the new ones.
# I thought the problem might be with ensurepip, but that doesn't seem to be it
# either.  For the moment, to upgrade all of them:
for i in `pyenv versions | grep '/envs/' | sed 's/^..//' | sed 's/ (.*//'`; do
    echo "*** $i ***"; pyenv activate $i; pip install --upgrade pip
done
pyenv deactivate

prompt display
